<!DOCTYPE html>
<html lang="id" x-data="ttsApp()" x-init="init()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panggilan Monse System</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="app.js"></script>
    <style>
        /* Additional styles */
        .client-id-short {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .master-badge {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .master-badge h4 {
            color: #856404;
            margin-bottom: 5px;
        }
        
        .master-badge p {
            color: #856404;
            margin: 3px 0;
            font-size: 14px;
        }
        
        .client-card.master {
            border: 2px solid #ffc107;
            background: #fff9e6;
        }
        
        .client-avatar.master {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #856404;
        }
        
        .audio-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-size: 14px;
            color: #856404;
        }
        
        .audio-warning i {
            color: #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <i class="fas fa-volume-up"></i>
                <div>
                    <h1>Panggilan Monse System</h1>
                    <p class="subtitle">Output audio terpusat dari satu komputer</p>
                </div>
            </div>
            <div class="header-controls">
                <div class="server-status" :class="serverStatus">
                    <i class="fas" :class="{
                        'fa-wifi': serverStatus === 'connected',
                        'fa-wifi-slash': serverStatus === 'disconnected',
                        'fa-exclamation-triangle': serverStatus === 'error'
                    }"></i>
                    <span x-text="serverStatusText"></span>
                </div>
                <div class="client-id" x-show="clientShortId">
                    <i class="fas fa-id-card"></i>
                    <span>ID: <span class="client-id-short" x-text="clientShortId"></span></span>
                </div>
            </div>
        </header>

        <!-- Master Control Panel -->
        <section class="master-control-panel" x-show="clientShortId">
            <div class="panel-header">
                <h3><i class="fas fa-crown"></i> Kontrol Master</h3>
                <div class="client-count">
                    <i class="fas fa-users"></i>
                    <span x-text="connectedClients.length"></span> komputer terhubung
                </div>
            </div>
            
            <div class="panel-body">
                <div x-show="!isMaster" class="master-request">
                    <div class="master-info">
                        <i class="fas fa-info-circle"></i>
                        <p>
                            Status: <strong>Client Biasa</strong> - 
                            <span x-show="masterShortId">
                                Master aktif: <strong x-text="masterShortId"></strong>. Anda dapat mengirim teks ke master.
                            </span>
                            <span x-show="!masterShortId">
                                Tidak ada master aktif. Silakan jadikan diri Anda master atau tunggu.
                            </span>
                        </p>
                    </div>
                    <button @click="requestMasterRole()" 
                            :disabled="isRequestingMaster || isMaster || masterShortId" 
                            class="btn btn-success btn-master">
                        <i class="fas fa-crown"></i>
                        <span x-text="isRequestingMaster ? 'Meminta...' : 'Jadikan Master'"></span>
                    </button>
                    <p class="hint">* Master akan menerima dan memutar audio HANYA di komputernya sendiri</p>
                    
                    <!-- Warning jika sudah ada master -->
                    <div x-show="masterShortId" class="audio-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Sudah ada Master (<strong x-text="masterShortId"></strong>). Anda tidak bisa menjadi master selama master aktif.</span>
                    </div>
                </div>
                
                <div x-show="isMaster" class="master-active">
                    <div class="master-badge">
                        <i class="fas fa-crown"></i>
                        <div>
                            <h4>Anda adalah Master Controller</h4>
                            <p>ID Master: <strong x-text="clientShortId"></strong></p>
                            <p><strong>Audio hanya akan diputar di komputer ini.</strong> Komputer lain tidak akan mendengar audio.</p>
                        </div>
                    </div>
                    <div class="master-controls">
                        <button @click="playAudio()" 
                                :disabled="!currentAudio || isPlaying" 
                                class="btn btn-primary">
                            <i class="fas fa-play"></i> Putar Audio (Hanya di PC ini)
                        </button>
                        <button @click="pauseAudio()" 
                                :disabled="!isPlaying" 
                                class="btn btn-warning">
                            <i class="fas fa-pause"></i> Jeda
                        </button>
                        <button @click="stopAudio()" 
                                :disabled="!currentAudio" 
                                class="btn btn-secondary">
                            <i class="fas fa-stop"></i> Stop
                        </button>
                        <button @click="releaseMasterRole()" 
                                class="btn btn-outline">
                            <i class="fas fa-sign-out-alt"></i> Lepaskan Peran Master
                        </button>
                    </div>
                    <div class="master-stats" x-show="currentAudio">
                        <div class="stat">
                            <i class="fas fa-clock"></i>
                            <span>Durasi: <strong x-text="currentAudio?.duration + ' detik'"></strong></span>
                        </div>
                        <div class="stat">
                            <i class="fas fa-user"></i>
                            <span>Dari: <strong x-text="currentAudio?.fromClientShortId || formatClientId(currentAudio?.fromClientId)"></strong></span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Connected Clients -->
        <section x-show="connectedClients.length > 0" class="card clients-section">
            <div class="card-header">
                <h3><i class="fas fa-network-wired"></i> Komputer Terhubung</h3>
                <span class="badge" x-text="connectedClients.length"></span>
            </div>
            <div class="card-body">
                <div class="clients-grid">
                    <template x-for="client in connectedClients" :key="client.id">
                        <div class="client-card" :class="{ 'master': client.isMaster }">
                            <div class="client-avatar" :class="{ 'master': client.isMaster }">
                                <i class="fas" :class="client.isMaster ? 'fa-crown' : 'fa-desktop'"></i>
                            </div>
                            <div class="client-info">
                                <h4 x-text="client.shortId || formatClientId(client.id)"></h4>
                                <p :class="{ 'master': client.isMaster }" 
                                   x-text="client.isMaster ? 'Master Controller' : 'Client'"></p>
                                <small x-text="formatTime(client.joinedAt)"></small>
                            </div>
                            <div class="client-status" :class="{ 'online': true, 'master': client.isMaster }">
                                <i class="fas fa-circle"></i>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </section>

        <main class="main-content">
            <!-- Input Section -->
            <section class="card input-section">
                <div class="card-header">
                    <h2><i class="fas fa-keyboard"></i> Input Teks</h2>
                    <div class="char-count">
                        <span x-text="charCount"></span>/<span x-text="maxChars"></span> karakter
                        <span x-show="wordCount > 0">â€¢ <span x-text="wordCount"></span> kata</span>
                    </div>
                </div>
                <div class="card-body">
                    <textarea x-model="text"
                              @input="updateCharCount()"
                              placeholder="Ketik atau tempel teks yang ingin diubah menjadi suara... (Audio akan diputar HANYA di komputer Master)"
                              rows="4"
                              :maxlength="maxChars"
                              :class="{'has-error': charCount >= maxChars}"
                              class="text-input"></textarea>

                    <div class="text-actions">
                        <button @click="clearText()" class="btn btn-outline">
                            <i class="fas fa-trash-alt"></i> Hapus
                        </button>
                        <button @click="pasteText()" class="btn btn-outline">
                            <i class="fas fa-paste"></i> Tempel
                        </button>
                        <!-- <button @click="loadExample()" class="btn btn-outline">
                            <i class="fas fa-lightbulb"></i> Contoh
                        </button> -->
                                 <button @click="convertToSpeech()" 
                        :disabled="isLoading || !text || !text.trim() || !masterShortId"
                        class="btn btn-primary btn-convert">
                    <i class="fas" :class="isLoading ? 'fa-spinner fa-spin' : 'fa-paper-plane'"></i>
                    <span x-text="getConvertButtonText()"></span>
                </button>
                
                <!-- <button @click="convertAndBroadcast()" 
                        :disabled="isLoading || !text || !text.trim() || !isMaster"
                        x-show="isMaster"
                        class="btn btn-success">
                    <i class="fas fa-broadcast-tower"></i>
                    <span>Kirim ke Semua Komputer</span>
                </button> -->
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section class="card settings-section">
                <div class="card-header">
                    <h2><i class="fas fa-sliders-h"></i> Pengaturan</h2>
                </div>
                <div class="card-body">
                    <div class="settings-grid">
                        <div class="setting">
                            <label for="language">
                                <i class="fas fa-language"></i> Bahasa
                            </label>
                            <select id="language" x-model="language" class="select-input">
                                <option value="" disabled>Pilih bahasa...</option>
                                <template x-for="lang in languages" :key="lang.code">
                                    <option :value="lang.code" x-text="`${lang.name} (${lang.nativeName})`"></option>
                                </template>
                            </select>
                        </div>

                        <div class="setting">
                            <label for="speed">
                                <i class="fas fa-tachometer-alt"></i> Kecepatan
                                <span class="speed-value" x-text="`${speed}x`"></span>
                            </label>
                            <div class="slider-container">
                                <input type="range" id="speed" x-model="speed" 
                                       min="0.5" max="2" step="0.1" class="slider">
                                <div class="slider-labels">
                                    <span>Lambat (0.5x)</span>
                                    <span>Normal (1.0x)</span>
                                    <span>Cepat (2.0x)</span>
                                </div>
                            </div>
                        </div>

                        <div class="setting">
                            <label for="priority">
                                <i class="fas fa-flag"></i> Prioritas
                            </label>
                            <select id="priority" x-model="priority" class="select-input">
                                <option value="low">Rendah</option>
                                <option value="normal">Normal</option>
                                <option value="high">Tinggi</option>
                                <option value="urgent">Sangat Penting</option>
                            </select>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Action Section -->
            <!-- <section class="action-section">
                <button @click="convertToSpeech()" 
                        :disabled="isLoading || !text || !text.trim() || !masterShortId"
                        class="btn btn-primary btn-convert">
                    <i class="fas" :class="isLoading ? 'fa-spinner fa-spin' : 'fa-paper-plane'"></i>
                    <span x-text="getConvertButtonText()"></span>
                </button>
                
                <button @click="convertAndBroadcast()" 
                        :disabled="isLoading || !text || !text.trim() || !isMaster"
                        x-show="isMaster"
                        class="btn btn-success">
                    <i class="fas fa-broadcast-tower"></i>
                    <span>Kirim ke Semua Komputer</span>
                </button>
            </section> -->

            <!-- Audio Player Section (Master Only) -->
            <section x-show="isMaster && currentAudio" class="card audio-section">
                <div class="card-header">
                    <h3><i class="fas fa-music"></i> Pemutar Audio (Master)</h3>
                    <div class="audio-source" x-show="currentAudio?.fromClientId">
                        <i class="fas fa-user"></i>
                        <span>Dari: <strong x-text="currentAudio?.fromClientShortId || formatClientId(currentAudio?.fromClientId)"></strong></span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="audio-player">
                        <audio id="masterAudioPlayer" 
                               :src="currentAudio?.audioUrl" 
                               controls
                               @play="onAudioPlay()"
                               @pause="onAudioPause()"
                               @ended="onAudioEnd()"
                               class="audio-element"></audio>
                        
                        <div class="audio-info">
                            <div class="info-item">
                                <i class="fas fa-clock"></i>
                                <span>Durasi: <strong x-text="currentAudio?.duration + ' detik'"></strong></span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-language"></i>
                                <span>Bahasa: <strong x-text="getLanguageName(currentAudio?.language)"></strong></span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-text-height"></i>
                                <span>Karakter: <strong x-text="currentAudio?.textLength"></strong></span>
                            </div>
                        </div>
                        
                        <div class="audio-actions">
                            <button @click="downloadAudio()" class="btn btn-outline">
                                <i class="fas fa-download"></i> Unduh
                            </button>
                            <button @click="shareAudio()" class="btn btn-outline">
                                <i class="fas fa-share-alt"></i> Bagikan
                            </button>
                            <button @click="clearAudio()" class="btn btn-outline">
                                <i class="fas fa-times"></i> Hapus
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Notification Section -->
            <section x-show="notifications.length > 0" class="notifications-section">
                <div class="notifications-container">
                    <template x-for="notification in notifications.slice().reverse().slice(0, 3)" :key="notification.id">
                        <div class="notification" :class="notification.type" @click="removeNotification(notification.id)">
                            <i class="fas" :class="getNotificationIcon(notification.type)"></i>
                            <div class="notification-content">
                                <p x-text="notification.message"></p>
                                <small x-text="formatTime(notification.timestamp)"></small>
                            </div>
                            <button @click="removeNotification(notification.id)" class="btn-close">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </template>
                </div>
            </section>

            <!-- History Section -->
            <section x-show="history.length > 0" class="card history-section">
                <div class="card-header">
                    <h3><i class="fas fa-history"></i> Riwayat Pengiriman</h3>
                    <button @click="clearHistory()" class="btn btn-small">
                        <i class="fas fa-trash"></i> Hapus Semua
                    </button>
                </div>
                <div class="card-body">
                    <div class="history-list">
                        <template x-for="(item, index) in history.slice().reverse()" :key="item.id">
                            <div class="history-item" :class="{ 'success': item.success, 'error': !item.success }">
                                <div class="history-content">
                                    <div class="history-text" x-text="truncateText(item.text, 80)"></div>
                                    <div class="history-meta">
                                        <span><i class="fas fa-language"></i> <span x-text="getLanguageCode(item.language)"></span></span>
                                        <span><i class="fas fa-clock"></i> <span x-text="formatTime(item.timestamp)"></span></span>
                                        <span><i class="fas" :class="item.success ? 'fa-check-circle' : 'fa-times-circle'"></i></span>
                                        <span x-show="item.master"><i class="fas fa-crown"></i> <span x-text="item.master"></span></span>
                                    </div>
                                </div>
                                <div class="history-actions">
                                    <button @click="loadHistoryItem(item)" class="btn btn-small">
                                        <i class="fas fa-redo"></i> Gunakan Lagi
                                    </button>
                                    <button @click="removeHistoryItem(item.id)" class="btn btn-small btn-outline">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </section>

            <!-- System Status -->
            <section class="card status-section">
                <div class="card-header">
                    <h3><i class="fas fa-chart-line"></i> Status Sistem</h3>
                </div>
                <div class="card-body">
                    <div class="status-grid">
                        <div class="status-item">
                            <i class="fas fa-server"></i>
                            <div>
                                <h4>Server</h4>
                                <p x-text="serverStatus === 'connected' ? 'Aktif' : 'Tidak Aktif'"></p>
                            </div>
                        </div>
                        <div class="status-item">
                            <i class="fas fa-users"></i>
                            <div>
                                <h4>Klien Terhubung</h4>
                                <p x-text="connectedClients.length"></p>
                            </div>
                        </div>
                        <div class="status-item">
                            <i class="fas fa-crown"></i>
                            <div>
                                <h4>Master</h4>
                                <p x-text="isMaster ? 'Anda (' + clientShortId + ')' : (masterShortId || 'Tidak Ada')"></p>
                            </div>
                        </div>
                        <div class="status-item">
                            <i class="fas fa-history"></i>
                            <div>
                                <h4>Riwayat</h4>
                                <p x-text="history.length + ' item'"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-info">
                    <p>TTS Multi-Client System v2.0 &copy; 2024</p>
                    <p class="footer-note">Sistem Text-to-Speech dengan output audio terpusat HANYA di komputer Master</p>
                </div>
                <div class="footer-links">
                    <button @click="showSystemInfo()" class="btn-link">
                        <i class="fas fa-info-circle"></i> Info Sistem
                    </button>
                    <button @click="testConnection()" class="btn-link">
                        <i class="fas fa-wifi"></i> Test Koneksi
                    </button>
                    <button @click="showHelp()" class="btn-link">
                        <i class="fas fa-question-circle"></i> Bantuan
                    </button>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modals -->
    <div x-show="showSystemInfoModal" class="modal-overlay" @click.self="showSystemInfoModal = false">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-info-circle"></i> Informasi Sistem</h3>
                <button @click="showSystemInfoModal = false" class="btn-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="system-info">
                    <h4>TTS Multi-Client System v2.0</h4>
                    <p><strong>Fitur Utama:</strong> Hanya satu Master yang aktif. Audio hanya diputar di komputer Master.</p>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <strong><i class="fas fa-user-crown"></i> Master Controller:</strong>
                            <p>Hanya satu komputer yang menjadi Master. Audio HANYA diputar di komputer ini.</p>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-desktop"></i> Client Biasa:</strong>
                            <p>Komputer yang hanya mengirim teks. Tidak bisa menjadi Master selama ada Master aktif.</p>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-id-card"></i> ID Pendek:</strong>
                            <p>Setiap client memiliki ID pendek (8 karakter) untuk memudahkan identifikasi.</p>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-volume-off"></i> Audio Terpusat:</strong>
                            <p>Audio hanya keluar dari speaker komputer Master, tidak dari komputer lain.</p>
                        </div>
                    </div>
                    
                    <h5>Alur Kerja:</h5>
                    <ol>
                        <li>Hanya satu client bisa menjadi Master</li>
                        <li>Client lain tidak bisa menjadi Master selama Master aktif</li>
                        <li>Client mengirim teks ke server</li>
                        <li>Server konversi teks ke audio</li>
                        <li>Audio dikirim HANYA ke Master</li>
                        <li>Master memutar audio di komputernya sendiri</li>
                        <li>Client lain tidak mendengar audio (kecuali broadcast)</li>
                    </ol>
                    
                    <div class="warning-box">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p><strong>Perhatian:</strong> Jika sudah ada Master aktif, client lain TIDAK BISA menjadi Master sampai Master melepaskan peran.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div x-show="showHelpModal" class="modal-overlay" @click.self="showHelpModal = false">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-question-circle"></i> Panduan Penggunaan</h3>
                <button @click="showHelpModal = false" class="btn-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="help-content">
                    <h4>Cara Menggunakan (Sistem Baru):</h4>
                    
                    <div class="step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h5>Menentukan Master</h5>
                            <p>Di komputer yang memiliki speaker, klik "Jadikan Master". <strong>Hanya satu komputer yang bisa menjadi Master.</strong></p>
                            <p class="note"><i class="fas fa-info-circle"></i> Jika sudah ada Master, tombol "Jadikan Master" akan dinonaktifkan.</p>
                        </div>
                    </div>
                    
                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h5>Mengirim Teks dari Client</h5>
                            <p>Di komputer lain (client biasa), masukkan teks dan klik "Kirim ke Master". Audio akan diputar <strong>HANYA di komputer Master</strong>.</p>
                        </div>
                    </div>
                    
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h5>Memutar Audio (Master Only)</h5>
                            <p>Di komputer Master, klik "Putar Audio" untuk memutar audio yang diterima. Audio hanya keluar dari speaker komputer Master.</p>
                        </div>
                    </div>
                    
                    <div class="step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <h5>Broadcast (Opsional)</h5>
                            <p>Master dapat mengirim audio ke semua komputer dengan klik "Kirim ke Semua Komputer".</p>
                        </div>
                    </div>
                    
                    <h5>Troubleshooting:</h5>
                    <ul>
                        <li><strong>Tidak bisa jadi Master:</strong> Sudah ada Master aktif. Tunggu Master melepaskan peran atau minta Master saat ini untuk melepaskan.</li>
                        <li><strong>Audio tidak keluar di Master:</strong> Pastikan komputer Master memiliki speaker aktif dan volume cukup.</li>
                        <li><strong>Client tidak bisa mengirim teks:</strong> Pastikan ada Master yang aktif (lihat status di panel Master).</li>
                        <li><strong>ID terlalu panjang:</strong> Sistem sekarang menggunakan ID pendek (8 karakter) untuk kemudahan.</li>
                        <li><strong>Koneksi terputus:</strong> Refresh halaman atau periksa jaringan.</li>
                    </ul>
                    
                    <div class="tip-box">
                        <i class="fas fa-lightbulb"></i>
                        <p><strong>Tip:</strong> Gunakan ID pendek untuk mengidentifikasi komputer. Master: <code class="master-id">MASTER</code>, Client: <code class="client-id">CLIENT</code></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio Element (Hidden untuk non-master) -->
    <audio id="hiddenAudio" style="display: none;"></audio>
    
    <script>
        // Additional JavaScript for better UX
        document.addEventListener('alpine:init', () => {
            // Add global helper
            Alpine.magic('shortId', () => {
                return (id) => {
                    if (!id) return '';
                    return id.length > 8 ? id.substring(0, 8) + '...' : id;
                }
            });
        });
    </script>
</body>
</html>